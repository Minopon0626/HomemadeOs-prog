     1                                          BOOT_LOAD equ 0x7c00        ;ブートプログラムのロード位置
     2                                  
     3                                          ORG     BOOT_LOAD           ;ロードアドレスをアセンブラに指示
     4                                  
     5                                  ;****************************************************************
     6                                  ;  マクロ
     7                                  ;****************************************************************
     8                                  %include "../include/macro.s"
     1                              <1> %macro cdecl 1-*.nolist
     2                              <1>     %rep %0 - 1
     3                              <1>         push %{-1:-1}
     4                              <1>         %rotate -1
     5                              <1>     %endrep
     6                              <1> 
     7                              <1>     %rotate -1
     8                              <1>         call %1
     9                              <1> 
    10                              <1>     %if 1 < %0
    11                              <1>         add sp, (__BITS__ >> 3) * (%0 - 1)
    12                              <1>     %endif
    13                              <1> %endmacro
     9                                  
    10                                  ;****************************************************************
    11                                  ;  エントリポイント
    12                                  ;****************************************************************
    13                                  entry:
    14 00000000 EB58                        jmp ipl                         ;IPLへジャンプ
    15                                  
    16                                      ;-------------------------------
    17                                      ;【BPB(BIOS Parameter Block)】
    18                                      ;-------------------------------
    19 00000002 90<rept>                    times   90 - ($ - $$) db 0x90   ;
    20                                  
    21                                      ;-------------------------------
    22                                      ;【IPL(Initial Program Loader)】
    23                                      ;-------------------------------
    24                                  ipl:
    25 0000005A FA                          cli                             ; // 割込み禁止
    26                                  
    27 0000005B B80000                      mov ax, 0x0000                  ; AX = 0x0000
    28 0000005E 8ED8                        mov ds, ax                      ; DS = 0x0000
    29 00000060 8EC0                        mov es, ax                      ; ES = 0x0000
    30 00000062 8ED0                        mov ss, ax                      ; SS = 0x0000
    31 00000064 BC007C                      mov sp, BOOT_LOAD               ; SP = 0x7C00
    32                                  
    33 00000067 FB                          sti                             ; // 割込み許可
    34 00000068 8816[8600]                  mov [BOOT.DRIVE], dl
    35                                  
    36                                      ;-------------------------------
    37                                      ; 文字を表示
    38                                      ;-------------------------------
    39                                  
    40 0000006C 6A58E8170083C402            cdecl putc, word 'X'
    41 00000074 6A59E80F0083C402            cdecl putc, word 'Y'
    42 0000007C 6A5AE8070083C402            cdecl putc, word 'Z'
    43                                  
    44                                      ;-------------------------------
    45                                      ; 処理の終了
    46                                      ;-------------------------------
    47 00000084 EBFE                        jmp $                           ;while(1); //(無限ループ)
    48                                  ALIGN 2, db 0
    49                                  BOOT:                               ;ブートドライブに関する情報
    50 00000086 0000                    .DRIVE: dw 0                        ;ドライブ番号
    51                                  
    52                                  ;***********************************
    53                                  ; モジュール
    54                                  ;***********************************
    55                                  
    56                                  %include "../modules/real/putc.s"
     1                              <1> putc:
     2                              <1> 	;---------------------------------------
     3                              <1> 	; 【スタックフレームの構築】
     4                              <1> 	;---------------------------------------
     5                              <1> 											; ------|--------
     6                              <1> 											;    + 4| 出力文字
     7                              <1> 											;    + 2| IP（戻り番地）
     8 00000088 55                  <1> 	push	bp								;  BP+ 0| BP（元の値）
     9 00000089 89E5                <1> 	mov		bp, sp							; ------+--------
    10                              <1> 
    11                              <1> 	;---------------------------------------
    12                              <1> 	; 【レジスタの保存】
    13                              <1> 	;---------------------------------------
    14 0000008B 50                  <1> 	push	ax
    15 0000008C 53                  <1> 	push	bx
    16                              <1> 
    17                              <1> 	;---------------------------------------
    18                              <1> 	; 【処理の開始】
    19                              <1> 	;---------------------------------------
    20 0000008D 8A4604              <1> 	mov		al, [bp + 4]					; 出力文字を取得
    21 00000090 B40E                <1> 	mov		ah, 0x0E						; テレタイプ式1文字出力
    22 00000092 BB0000              <1> 	mov		bx, 0x0000						; ページ番号と文字色を0に設定
    23 00000095 CD10                <1> 	int		0x10							; ビデオBIOSコール
    24                              <1> 
    25                              <1> 	;---------------------------------------
    26                              <1> 	; 【レジスタの復帰】
    27                              <1> 	;---------------------------------------
    28 00000097 5B                  <1> 	pop		bx
    29 00000098 58                  <1> 	pop		ax
    30                              <1> 
    31                              <1> 	;---------------------------------------
    32                              <1> 	; 【 スタックフレームの破棄】
    33                              <1> 	;---------------------------------------
    34 00000099 89EC                <1> 	mov		sp, bp							;
    35 0000009B 5D                  <1> 	pop		bp
    36                              <1> 
    37 0000009C C3                  <1> 	ret
    57                                  
    58                                  ;***********************************
    59                                  ;   ブートフラグ(先頭512バイトの終了)
    60                                  ;***********************************
    61 0000009D 00<rept>                    times 510 - ($ - $$) db 0x00
    62 000001FE 55AA                        db 0x55, 0xAA
